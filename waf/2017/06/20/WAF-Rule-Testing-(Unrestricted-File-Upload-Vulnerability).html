<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Fools Of Security are Information Security Enthusiast. We are an Open Source Knowledge sharing platform Relating to Information security and its advancements.">
  <meta name="author" content="Fools Of Security">
  <meta name="keywords" content="">
  <link rel="canonical" href="/waf/2017/06/20/WAF-Rule-Testing-(Unrestricted-File-Upload-Vulnerability).html">
  <title> Fools Of Security&ensp;| WAF Rule Testing (Unrestricted File Upload Vulnerability)</title>

  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

  <!-- Custom CSS -->
  <link href="/css/grayscale.css" rel="stylesheet"><!-- Custom Fonts -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
  <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/rrssb.css" />
  <link rel="stylesheet" href="/css/custom.css" />
  <meta name="theme-color" content="#000000">
  <!-- Windows Phone -->
  <meta name="msapplication-navbutton-color" content="#000000">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
<!-- Syntax highlight in post pages -->
  <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/monokai_sublime.min.css"></head>
<body>
<nav class="navbar navbar-custom navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-main-collapse">
        <i class="fa fa-bars"></i>
      </button><a class="navbar-brand" href="/"><div><img src="/img/fos-border.ico" alt=""> Fools Of Security
          </div>
        </a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse navbar-right navbar-main-collapse">
      <ul class="nav navbar-nav"><!-- Blog, Post, Tag and Error pages --><li><a href="/#about"> About </a></li><li><a href="/blog/"> Blog </a></li><li><a href="/video/"> Video </a></li><li><a href="/#timeline"> Timeline </a></li><li><a href="/project/"> Project </a></li><li><a href="/#contact"> Contact </a></li></ul>
    </div>
  </div>
</nav>

<section id="post" class="container content-section text-center">
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <h1><strong>WAF Rule Testing (Unrestricted File Upload Vulnerability)</strong></h1>
          <h4>
            <strong>20 Jun 2017</strong>
            <small>
              . category:
              <a class="category" href="/categories/waf.html">
                waf
              </a>.
              <a href="/waf/2017/06/20/WAF-Rule-Testing-(Unrestricted-File-Upload-Vulnerability).html#disqus_thread">Comments</a>
              <br /><a class="tag" href="/tags/tutorial.html">#tutorial</a></small>
          </h4>

          <section class="text-justify">
            <p>Testing Unrestricted File upload vulnerability on xvwa application with OWASP CRS &amp;&amp; CWAF 1.128 (latest version) Ruleset.</p>

<p><strong>Testing Unrestricted File Upload Vulnerability on  OWASP CRS:</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>
OWASP CRS block possible malicious files upload i.e .php files from getting compromised by .php shell
but still we can find little flaw in the OWASP CRS

REQUEST-933-APPLICATION-ATTACK-PHP 
rule ID:933110 
PHP support Extension: .php, .phtml, .php3, .php4, .php5, .php7, .phps 
Regex Pattern: .*\.(?:php\d*|phtml)\.*$

.  - Any character
*  - Zero or more character
\d - A digit [0-9]
?: - A non-capturing group 

Test the regex on http://www.regextester.com/ or other  online regex testing  website.
</code></pre>
</div>
<p><em>Try to understand how actually the regex detect the file extension .php?</em></p>

<p><strong>Regex Overview:</strong> <br /></p>
<div class="highlighter-rouge"><pre class="highlight"><code>Regex pattern detect, if the user upload a file as  .php or .php1 or .php2 or .php3 or .php4 or .php5 or .php7, but it failed to detect the .phps extension, because they never included the .phps  in regex pattern to detected by OWASP CRS.

Anyway it not a bug :), even the file .phps was uploaded successfully in the server, it has no use, as default cofiguration on apache  php5 or php7.conf in /etc/apache2/mods-available/ will denied the file with .phps to get executed on apache server. 

phase 1:We have successfully upload a .phps file on the server
</code></pre>
</div>
<p><br /></p>

<p><strong>phase 2: Lets think little different scenario, if .htaccess has been enabled on this apache server. then it going to be a 
loop hole for us to get easily bypass OWASP CRS</strong></p>

<p>As far i anlayzed  OWASP CRS, it does not have any rules to block uploading <code class="highlighter-rouge">.htacess</code> file :).</p>

<p>So we need to create .htaccess  file to allow .phps to execute as file type <strong>application/x-httpd-php</strong> (or)
we can allow any file extension which is not be detected by the OWASP CRS can be execute as application/x-httpd-php. <code class="highlighter-rouge">i.e  .phps as .php  (or)  jpg as .php</code></p>

<p>Let created a .htaccess file :) <br /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>#.htaccess file to be uploaded on the vulnerable server
&lt;FilesMatch ".+\.phps$"&gt;
    SetHandler application/x-httpd-php
    Require all granted
&lt;/FilesMatch&gt;
</code></pre>
</div>

<p>once you have upload the .htacess file in the server, then let check the  previously upoaded .phps file  in the browser.<br />
.phps file will be  sucessfully executed on server and we get phpinfo page.</p>

<p><code class="highlighter-rouge">Finally we have bypassed OWASP CRS in uploading the .php shell</code></p>

<hr />

<p><strong>Testing Unrestricted File Upload Vulnerability on CWAF 1.128</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>When i am started testing the CWAF, it does not take much time to bypass file upload restriction. Becuase when i am going through the CWAF rules, i understand they have  no rules to block malicious file upload `i.e .php file`, which make us easily to upload any .php file on the server. :) 

CWAF failed to detect these following payload, which lead us to upload shell on the server.
.php, .phtml, .php3, .php4, .php5, .php7, .phps

Let try uploading the C99 or 404 error shell. :)
We have upload 404 shell on the server and got acess to the internal server path
</code></pre>
</div>
<p><code class="highlighter-rouge">Finally we are able to bypass OWASP &amp;&amp; CWAF ruleset for uploading .php shell in the server.</code></p>

<p><strong>Final Overview:</strong><br />
<strong>Unrestricted File Upoad : A5 Security Misconfiguration OWASP TOP 10]</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>OWASP CRS: Good | Hard to bypass, but still it possible depend up on the scenario like .htacess enabled on the server &amp;&amp; no rule to block .htaccess file upload.

CWAF 1.128 :  Bad | No rules to block malicious file upload, more rules should be updated  to prevent application from  common OWASP Top 10 vulnerability || rules should be deployed &amp; tested in real time environment  i.e testing rules on vulnerable application
</code></pre>
</div>

<p><strong>Note:</strong>
   OWASP CRS does not block uploading other flle extension like .exe, .py , .sh ..etc, it block only  .php file upload. becuase based on the application, .php shell upload has high impact on the server and application level. so regex was written in OWASP CRS to block only .php file upload</p>

<h3 id="demo-video">Demo Video</h3>

<p><a href="https://www.youtube.com/watch?v=lWoxAjvgiHs"><img src="https://img.youtube.com/vi/lWoxAjvgiHs/0.jpg" alt="Alt text" /></a></p>

<h3 id="useful-links">Useful links:</h3>
<ol>
  <li><a href="www.modsecurity.com/">Modsecurity</a></li>
  <li><a href="https://www.kali.org/">Kali</a></li>
  <li><a href="https://www.debuggex.com/">Debuggex</a></li>
  <li><a href="https://github.com/s4n7h0/xvwa">XVWA</a></li>
  <li><a href="https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual#UNIX">Modsecurity Reference Manual</a></li>
</ol>


          </section>
          <br><div class="sharing">
    <br/>
    <br/>
    <ul>
        <li><i class="fa fa-share-square-o"></i></li>
        
        <li><a href="mailto:?subject=WAF Rule Testing (Unrestricted File Upload Vulnerability)&body=http://foolsofsecurity.com/waf/2017/06/20/WAF-Rule-Testing-(Unrestricted-File-Upload-Vulnerability).html" rel="nofollow" target="_blank" title="Share on Email">
                <i class="fa fa-envelope-square"></i>
        </a></li>
        
        
        <li><a href="http://www.linkedin.com/shareArticle?url=http://foolsofsecurity.com/waf/2017/06/20/WAF-Rule-Testing-(Unrestricted-File-Upload-Vulnerability).html&title=WAF Rule Testing (Unrestricted File Upload Vulnerability)" rel="nofollow" target="_blank" title="Share on LinkedIn">
                <i class="fa fa-linkedin-square"></i>
        </a></li>
        
        
        <li><a href="https://twitter.com/intent/tweet?text=WAF Rule Testing (Unrestricted File Upload Vulnerability)&url=http://foolsofsecurity.com/waf/2017/06/20/WAF-Rule-Testing-(Unrestricted-File-Upload-Vulnerability).html" rel="nofollow" target="_blank" title="Share on Twitter">
                <i class="fa fa-twitter-square"></i>
        </a></li>
        
        
        <li><a href="https://facebook.com/sharer.php?u=http://foolsofsecurity.com/waf/2017/06/20/WAF-Rule-Testing-(Unrestricted-File-Upload-Vulnerability).html" rel="nofollow" target="_blank" title="Share on Facebook">
                <i class="fa fa-facebook-square"></i>
        </a></li>
        

        
        <li><a href="https://plus.google.com/share?url=http://foolsofsecurity.com/waf/2017/06/20/WAF-Rule-Testing-(Unrestricted-File-Upload-Vulnerability).html" rel="nofollow" target="_blank" title="Share on Google+">
                <i class="fa fa-google-plus-square"></i>
        </a></li>
        

        
        <li><a href="http://reddit.com/submit?url=http://foolsofsecurity.com/waf/2017/06/20/WAF-Rule-Testing-(Unrestricted-File-Upload-Vulnerability).html&title=WAF Rule Testing (Unrestricted File Upload Vulnerability)" rel="nofollow" target="_blank" title="Share on Reddit">
                <i class="fa fa-reddit-square"></i>
        </a></li>
        
        
        <li><a href="https://pinterest.com/pin/create/button/?url=http://foolsofsecurity.com/waf/2017/06/20/WAF-Rule-Testing-(Unrestricted-File-Upload-Vulnerability).html" rel="nofollow" target="_blank" title="Share on Pinterest">
                <i class="fa fa-pinterest-square"></i>
        </a></li>
        
    </ul>
</div>
<br/>
<br/><div id="disqus_thread"></div>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><hr /><div class="author row">
            <img class="col-xs-4 col-sm-3 col-md-2" src="/img/author.png" alt="Me" />
            <p class="col-xs-8 col-sm-9 col-md-10">
              Umar Farook is an Security Researcher & AppSec Enthusiast. He always approach App Security with innovative ideas  to explore and prevent Modern web application attacks. In spare time, he work on scrapying data from website and automating AppSec with Python.
            </p>
          </div></div>
      </div>
    </section>
<footer>
    <br>
<ul class="list-inline social-buttons"><li><a href="https://github.com/umarfarook882" target="_blank"><i class="fa fa-github fa-fw"></i></a></li><li><a href="https://www.youtube.com/channel/UCEBHO0kD1WFvIhf9wBCU-VQ" target="_blank"><i class="fa fa-youtube-play fa-fw"></i></a></li><li><a href="http://fosecurity.blogspot.in/" target="_blank"><i class="fa fa-globe fa-fw"></i></a></li></ul>

<p><br></p>
    <div class="container text-center">
        <p>Copyright &copy; Fools Of Security 2017</p><p style="font-size: 16px;"><a href="https://zerobin.net/?f1744fd662ccc911#AknpWQMXs3ZSDTvvgLTD67W7D9PrlI5vv06zDDG217I=" target="_blank"><i
                class="fa fa-key"></i> Fools of Security via PGP</a></p></div>
</footer>

<!-- Javascript Start -->
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<!-- Plugin JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>

<script>
function toggleNavCollapse(){50<$(".navbar").offset().top?$(".navbar-fixed-top").addClass("top-nav-collapse"):$(".navbar-fixed-top").removeClass("top-nav-collapse");}
$(document).ready(toggleNavCollapse);
$(window).scroll(toggleNavCollapse);$(function(){$("a.page-scroll").bind("click",function(b){var a=$(this);$("html, body").stop().animate({scrollTop:$(a.attr("href")).offset().top-50},1500,"easeInOutExpo",function(){a.blur()});b.preventDefault()})});$(".navbar-collapse ul li a").click(function(){$(".navbar-toggle:visible").click()});
</script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

    <script type="text/javascript">
    var disqus_shortname = 'foolsofsecurity-com';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
  <script src="/js/rrssb.min.js"></script><script>
function addTohistory() {
  if (!window.location.host.startsWith("127.0.0.1")) {
    history.pushState({}, 'WAF Rule Testing (Unrestricted File Upload Vulnerability)', 'http://foolsofsecurity.com/waf/2017/06/20/WAF-Rule-Testing-(Unrestricted-File-Upload-Vulnerability).html');
  }
}
</script>

<!-- Javascript End -->
</body>
</html>

